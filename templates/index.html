<!-- VERSION: 2024-12-19-revised -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Braille Business Card STL Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Theme CSS Variables */
        :root {
            /* Light mode colors */
            --bg-gradient-start: #e0e7ff;
            --bg-gradient-end: #f6f8fa;
            --bg-primary: #fff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-input: #f9fafb;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-tertiary: #666;
            --border-primary: #e2e8f0;
            --border-secondary: #cbd5e1;
            --border-focus: #3182ce;
            --btn-primary-bg: linear-gradient(90deg, #3182ce 60%, #63b3ed 100%);
            --btn-primary-hover-bg: linear-gradient(90deg, #2563eb 60%, #4299e1 100%);
            --btn-success-bg: #10b981;
            --btn-success-hover-bg: #059669;
            --btn-secondary-bg: #9ca3af;
            --btn-tertiary-bg: #6b7280;
            --error-bg: #fee2e2;
            --error-border: #fecaca;
            --error-text: #b91c1c;
            --info-bg: #dbeafe;
            --info-border: #93c5fd;
            --info-text: #1e40af;
            --shadow-light: rgba(49,130,206,0.10);
            --shadow-medium: rgba(49,130,206,0.18);
            --stl-mesh-color: #6699cc;
        }

        /* Dark mode colors */
        [data-theme="dark"] {
            --bg-gradient-start: #1a202c;
            --bg-gradient-end: #2d3748;
            --bg-primary: #2d3748;
            --bg-secondary: #374151;
            --bg-tertiary: #4a5568;
            --bg-input: #374151;
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --text-tertiary: #cbd5e1;
            --border-primary: #4a5568;
            --border-secondary: #718096;
            --border-focus: #63b3ed;
            --btn-primary-bg: linear-gradient(90deg, #4299e1 60%, #63b3ed 100%);
            --btn-primary-hover-bg: linear-gradient(90deg, #3182ce 60%, #4299e1 100%);
            --btn-success-bg: #059669;
            --btn-success-hover-bg: #047857;
            --btn-secondary-bg: #718096;
            --btn-tertiary-bg: #4a5568;
            --error-bg: #742a2a;
            --error-border: #9b2c2c;
            --error-text: #fed7d7;
            --info-bg: #2c5282;
            --info-border: #3182ce;
            --info-text: #bee3f8;
            --shadow-light: rgba(0,0,0,0.3);
            --shadow-medium: rgba(0,0,0,0.5);
            --stl-mesh-color: #90cdf4;
        }

        /* High contrast mode */
        [data-theme="high-contrast"] {
            --bg-gradient-start: #000;
            --bg-gradient-end: #000;
            --bg-primary: #000;
            --bg-secondary: #000;
            --bg-tertiary: #000;
            --bg-input: #000;
            --text-primary: #fff;
            --text-secondary: #fff;
            --text-tertiary: #fff;
            --border-primary: #fff;
            --border-secondary: #fff;
            --border-focus: #ffff00;
            --btn-primary-bg: #fff;
            --btn-primary-hover-bg: #ffff00;
            --btn-success-bg: #00ff00;
            --btn-success-hover-bg: #00ff00;
            --btn-secondary-bg: #fff;
            --btn-tertiary-bg: #fff;
            --error-bg: #ff0000;
            --error-border: #ff0000;
            --error-text: #fff;
            --info-bg: #0000ff;
            --info-border: #0000ff;
            --info-text: #fff;
            --shadow-light: none;
            --shadow-medium: none;
            --stl-mesh-color: #ffff00;
        }

        /* High contrast mode button text colors */
        [data-theme="high-contrast"] button {
            color: #000 !important;
        }

        /* Apply transition to theme changes */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* Skip Link for Keyboard Navigation */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--border-focus);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 0 0 8px 0;
            z-index: 1000;
            transition: top 0.3s;
        }

        .skip-link:focus {
            top: 0;
            outline: 3px solid var(--border-focus);
            outline-offset: 2px;
        }

        /* Theme Toggle Button */
        .theme-controls {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 999;
        }

        .theme-toggle-btn {
            background: var(--bg-primary);
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            padding: 0.6em 1em;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5em;
            transition: all 0.2s;
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .theme-toggle-btn:hover {
            background: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }

        .theme-toggle-btn:focus {
            outline: 3px solid var(--border-focus);
            outline-offset: 2px;
        }

        .theme-icon {
            font-size: 1.2em;
        }

        /* Enhanced focus indicators for all interactive elements */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus,
        a:focus {
            outline: 3px solid var(--border-focus);
            outline-offset: 2px;
        }

        /* Ensure proper keyboard navigation visibility */
        *:focus-visible {
            outline: 3px solid var(--border-focus) !important;
            outline-offset: 2px !important;
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Fieldset styling */
        fieldset {
            border: none;
            padding: 0;
            margin: 0;
        }

        .line-input-fieldset {
            margin: 0;
        }

        /* Braille preview styles */
        .braille-preview {
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
        }

        .preview-heading {
            margin-top: 0;
            color: var(--text-primary);
        }

        .preview-line-success {
            margin: 10px 0;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 5px;
            border: 1px solid var(--border-primary);
        }

        .preview-line-error {
            margin: 10px 0;
            padding: 10px;
            background: var(--error-bg);
            border-radius: 5px;
            border: 1px solid var(--error-border);
            color: var(--error-text);
        }

        .expert-info {
            font-size: 0.9em;
            color: var(--text-tertiary);
            font-style: italic;
            margin-bottom: 1em;
            text-align: center;
        }

        body {
            background: linear-gradient(120deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            font-family: 'Inter', system-ui, Arial, sans-serif;
            margin: 0;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            padding: 2em;
            color: var(--text-primary);
        }
        .main-layout {
            display: flex;
            flex-direction: row;
            gap: 2.5em;
            background: var(--bg-primary);
            border-radius: 22px;
            box-shadow: 0 8px 32px var(--shadow-light);
            padding: 2.5em 2.5em 2.5em 2.5em;
            max-width: 1100px;
            width: 100%;
            margin: 0;
        }
        .viewer-section {
            flex: 2 1 0%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
        }
        #viewer {
            width: 100%;
            min-width: 320px;
            max-width: 700px;
            height: 420px;
            border-radius: 18px;
            border: 2px solid var(--border-primary);
            background: var(--bg-tertiary);
            box-shadow: 0 4px 24px var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 0 1.5em 0;
            transition: box-shadow 0.2s;
        }
        #viewer:focus-within, #viewer:active {
            box-shadow: 0 8px 32px var(--shadow-medium);
        }
        .form-section {
            flex: 1 1 0%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 320px;
            max-width: 400px;
        }
        h1 {
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 0.7em;
            color: var(--text-primary);
            text-align: left;
        }
        .info-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 1em;
            margin-bottom: 1.5em;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        .info-panel p {
            margin: 0.3em 0;
        }
        .grade-selection {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 1em;
            margin-bottom: 1.5em;
        }
        .grade-label {
            font-weight: 600;
            color: var(--text-primary);
            display: block;
            margin-bottom: 0.8em;
            font-size: 0.9em;
        }
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.6em;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.6em;
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        .radio-option input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }
        .radio-text {
            cursor: pointer;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 1.1em;
        }
        .line-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.8em;
        }
        .line-input {
            display: flex;
            align-items: center;
            gap: 0.8em;
        }
        .line-label {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 60px;
            font-size: 0.9em;
        }
        input[type="text"] {
            flex: 1;
            border: 1.5px solid var(--border-secondary);
            border-radius: 8px;
            padding: 0.8em;
            font-size: 1em;
            font-family: inherit;
            background: var(--bg-input);
            color: var(--text-primary);
            transition: border 0.2s;
        }
        input[type="text"]:focus {
            border: 1.5px solid var(--border-focus);
            outline: none;
            background: var(--bg-primary);
        }
        
        /* Ensure number inputs are properly styled and functional */
        input[type="number"] {
            flex: 1;
            border: 1.5px solid var(--border-secondary);
            border-radius: 8px;
            padding: 0.8em;
            font-size: 1em;
            font-family: inherit;
            background: var(--bg-input);
            color: var(--text-primary);
            transition: border 0.2s;
            min-width: 80px;
        }
        
        input[type="number"]:focus {
            border: 1.5px solid var(--border-focus);
            outline: none;
            background: var(--bg-primary);
        }
        
        input[type="number"]:hover {
            border-color: var(--border-primary);
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.8em;
            margin-top: 1em;
        }
        button {
            border: none;
            border-radius: 8px;
            padding: 0.7em 0;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }
        button[type="submit"] {
            background: var(--btn-primary-bg);
            color: #fff;
            box-shadow: 0 2px 8px var(--shadow-light);
        }
        button[type="submit"]:hover {
            background: var(--btn-primary-hover-bg);
            transform: translateY(-2px) scale(1.03);
        }
        #download-btn {
            background: var(--btn-secondary-bg);
            color: #fff;
            cursor: not-allowed;
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        
        #download-btn.ready {
            background: var(--btn-success-bg);
            cursor: pointer;
            opacity: 1;
            box-shadow: 0 2px 8px var(--shadow-light);
        }
        
        #download-btn.ready:hover {
            background: var(--btn-success-hover-bg);
            transform: translateY(-2px) scale(1.03);
        }
        
        #generate-stl-btn {
            background: var(--btn-primary-bg);
            color: #fff;
            box-shadow: 0 2px 8px var(--shadow-light);
        }
        
        #generate-stl-btn:hover {
            background: var(--btn-primary-hover-bg);
            transform: translateY(-2px) scale(1.03);
        }
        
        .button-row {
            display: flex;
            gap: 1em;
            align-items: center;
            margin-bottom: 1em;
        }
        #download-counter-plate-btn {
            background: var(--btn-tertiary-bg);
            color: #fff;
        }
        #download-counter-plate-btn:hover {
            background: var(--btn-tertiary-bg);
            opacity: 0.9;
            transform: translateY(-2px) scale(1.03);
        }
        #error-message {
            color: var(--error-text);
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            border-radius: 6px;
            padding: 0.7em 1em;
            margin-top: 0.5em;
            font-size: 1em;
            display: none;
            align-items: center;
            gap: 0.5em;
        }
        
        #error-message.info {
            color: var(--info-text);
            background: var(--info-bg);
            border: 1px solid var(--info-border);
        }
        
        .expert-mode-toggle {
            margin-top: 1em;
            text-align: center;
        }
        
        .expert-toggle-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            padding: 0.6em 1em;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5em;
            transition: background 0.2s, border-color 0.2s;
        }
        
        .expert-toggle-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-primary);
        }
        
        .expert-toggle-btn.active {
            background: var(--border-focus);
            color: #fff;
            border-color: var(--border-focus);
        }
        
        .expert-toggle-btn.active #expert-toggle-text {
            color: #fff;
        }
        
        .expert-toggle-btn.active #expert-toggle-icon {
            transform: rotate(180deg);
        }
        
        .expert-settings {
            margin-top: 1.5em;
            padding-top: 1.5em;
            border-top: 1px solid var(--border-primary);
        }
        
        /* Ensure Expert Mode inputs are properly spaced and visible */
        .expert-settings .grade-selection {
            margin-bottom: 1em;
        }
        
        .expert-settings input[type="number"] {
            margin-top: 0.3em;
            margin-bottom: 0.5em;
        }
        
        .expert-settings label {
            display: block;
            margin-bottom: 0.3em;
            font-weight: 500;
            color: var(--text-primary);
        }
        .expert-mode-toggle {
            margin-top: 1em;
            text-align: center;
        }
        .expert-settings {
            margin-top: 1.5em;
            padding-top: 1.5em;
            border-top: 1px solid var(--border-primary);
        }
        
        .info-dropdown {
            margin-bottom: 1.5em;
        }
        
        .info-toggle-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 0.8em 1em;
            font-size: 0.95em;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            transition: background 0.2s, border-color 0.2s;
        }
        
        .info-toggle-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-secondary);
        }
        
        .info-toggle-btn.active {
            background: var(--border-focus);
            color: #fff;
            border-color: var(--border-focus);
        }
        
        .info-toggle-btn.active #info-toggle-text {
            color: #fff;
        }
        
        .info-toggle-btn.active #info-toggle-icon {
            transform: rotate(180deg);
        }
        
        .info-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 1em;
            margin-top: 0.5em;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        .info-content p {
            margin: 0.3em 0;
        }
        
        @media (max-width: 1100px) {
            body {
                padding: 1em;
            }
            .main-layout {
                flex-direction: column;
                padding: 1.2em 0.5em 1.5em 0.5em;
                max-width: 98vw;
                gap: 1.5em;
            }
            .viewer-section, .form-section {
                max-width: 98vw;
                min-width: unset;
            }
            #viewer {
                max-width: 98vw;
                min-width: 0;
                height: 320px;
            }
        }
        @media (max-width: 700px) {
            body {
                padding: 0.5em;
            }
            .main-layout {
                padding: 0.5em 0.1em 1em 0.1em;
            }
            #viewer {
                height: 220px;
            }
            .line-input {
                flex-direction: column;
                align-items: stretch;
                gap: 0.3em;
            }
            .line-label {
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <!-- Skip Navigation Link for Keyboard Users -->
    <a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>
    
    <!-- Theme Toggle Button -->
    <div class="theme-controls" role="group" aria-label="Theme selection">
        <button id="theme-toggle" class="theme-toggle-btn" aria-label="Toggle theme" title="Toggle between light, dark, and high contrast themes">
            <span class="theme-icon" aria-hidden="true">ðŸŒž</span>
            <span class="theme-text">Light</span>
        </button>
    </div>
    
    <div class="main-layout" role="main" id="main-content">
        <div class="viewer-section" role="region" aria-label="3D STL Preview">
            <div id="viewer" role="img" aria-label="3D preview of braille business card STL file" tabindex="0"></div>
            <div class="button-row">
                <button type="button" id="generate-stl-btn" aria-label="Generate STL file from entered text">Generate STL</button>
                <button id="download-btn" aria-label="Download generated STL file" aria-disabled="true">Download STL</button>
            </div>
        </div>
        <div class="form-section" role="region" aria-label="Braille Card Configuration">
            <h1 id="main-heading">Braille Business Card STL Generator</h1>
            
            <div class="info-panel">
                <p><strong>Program Description:</strong> Creates two matching STLs for a standard 3.5â€³ Ã— 2â€³ card: <strong>Embossing Plate</strong> (cone dots) and <strong>Universal Counter Plate</strong> (hemispherical recessed dots).</p>
            </div>
            
            <div class="info-dropdown">
                <button type="button" id="info-toggle" class="info-toggle-btn">
                    <span id="info-toggle-text">More Information and Instructions</span>
                    <span id="info-toggle-icon">â–¼</span>
                </button>
                <div id="info-content" class="info-content" style="display: none;">
                    <p><strong>Instructions:</strong></p>
                    <ol style="margin: 0.3em 0; padding-left: 1.5em;">
                        <li>Enter up to <strong>4 lines</strong> of English text, then click <strong>"Generate STL."</strong> The app auto-translates to <strong>Unified English Braille (UEB)</strong>.</li>
                        <li>Review the 3D preview. If it looks correct, click <strong>"Download STL."</strong></li>
                        <li>Click <strong>"Universal Counter Plate"</strong> and repeat the steps to generate and download the matching counter plate (if you haven't printed one yet).</li>
                        <li>Need specific dimensions? Open <strong>Expert Mode</strong> to adjust card size, spacing, and dot parameters.</li>
                    </ol>
                    <p><strong>Acknowledgements:</strong></p>
                    <ul style="margin: 0.3em 0; padding-left: 1.5em;">
                        <li>Code authored by <strong>Claude 4.1 Opus</strong>.</li>
                        <li>Powered by <a href="https://liblouis.io/" target="_blank" style="color: #3182ce; text-decoration: none;"><strong>Liblouis</strong></a>, an open-source professional braille translator.</li>
                        <li>Extra thanks to <strong>Tobi Weinberg</strong> for the substantial time and effort he volunteered to help start this project and see it through.</li>
                    </ul>
                </div>
            </div>
            
            <form id="braille-form" aria-labelledby="main-heading">
                <div class="line-input-group">
                    <fieldset class="line-input-fieldset">
                        <legend class="grade-label">Enter Text for Braille Translation</legend>
                        <div class="line-input">
                            <label for="line1" class="line-label">Line 1</label>
                            <input type="text" id="line1" name="line1" placeholder="Enter English text here..." maxlength="50" aria-describedby="line1-help">
                            <span id="line1-help" class="sr-only">Maximum 50 characters for line 1</span>
                        </div>
                        <div class="line-input">
                            <label for="line2" class="line-label">Line 2</label>
                            <input type="text" id="line2" name="line2" placeholder="Enter English text here..." maxlength="50" aria-describedby="line2-help">
                            <span id="line2-help" class="sr-only">Maximum 50 characters for line 2</span>
                        </div>
                        <div class="line-input">
                            <label for="line3" class="line-label">Line 3</label>
                            <input type="text" id="line3" name="line3" placeholder="Enter English text here..." maxlength="50" aria-describedby="line3-help">
                            <span id="line3-help" class="sr-only">Maximum 50 characters for line 3</span>
                        </div>
                        <div class="line-input">
                            <label for="line4" class="line-label">Line 4</label>
                            <input type="text" id="line4" name="line4" placeholder="Enter English text here..." maxlength="50" aria-describedby="line4-help">
                            <span id="line4-help" class="sr-only">Maximum 50 characters for line 4</span>
                        </div>
                    </fieldset>
                </div>

                <div class="grade-selection">
                    <fieldset>
                        <legend class="grade-label">Select Translation:</legend>
                        <div class="radio-group" role="radiogroup" aria-required="true">
                        <label class="radio-option">
                            <input type="radio" name="grade" value="g2" checked>
                            <span class="radio-text">English, U.S., contracted (Grade 2)</span>
                            <div style="margin-top: 4px; font-size: 0.85em; color: var(--text-tertiary); font-style: italic;">(UEB): Uses modern contractions, so check limits after translation</div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="grade" value="g1">
                            <span class="radio-text">English, U.S., uncontracted (Grade 1)</span>
                        </label>
                        </div>
                        <div class="grade-info" style="margin-top: 8px; font-size: 0.9em; color: var(--text-tertiary); font-style: italic;" role="note">
                            <span id="grade1-info" style="display: none;" aria-live="polite">Uncontracted should be used in special circumstances only. Contracted is the default option.</span>
                            <span id="grade2-info" style="display: none;" aria-live="polite">Grade 2 (contracted) is the default and recommended option for most use cases.</span>
                        </div>
                    </fieldset>
                </div>

                <div class="grade-selection">
                    <fieldset>
                        <legend class="grade-label">Select Plate to Generate</legend>
                        <div class="radio-group" role="radiogroup" aria-required="true">
                            <label class="radio-option">
                                <input type="radio" name="plate_type" value="positive" checked aria-describedby="emboss-plate-desc">
                                <span class="radio-text">Embossing Plate</span>
                            </label>
                            <span id="emboss-plate-desc" class="sr-only">Creates raised braille dots for embossing cards</span>
                            <label class="radio-option">
                                <input type="radio" name="plate_type" value="negative" aria-describedby="counter-plate-desc">
                                <span class="radio-text">Universal Counter Plate</span>
                            </label>
                            <span id="counter-plate-desc" class="sr-only">Creates recessed dots to support embossing process</span>
                            <div id="negative-plate-offset-container" style="display: none; margin-top: 10px;" role="group" aria-label="Counter plate settings">
                                <label for="counter_plate_dot_size_offset">Counter Dot Diameter Offset (mm):</label>
                                <input type="number" id="counter_plate_dot_size_offset" name="counter_plate_dot_size_offset" value="0.0" step="0.1" aria-describedby="offset-help" title="Adjusts the counter plate braille dot base diameter relative to the emboss plate diameter">
                                <div id="offset-help" style="font-size: 0.85em; color: var(--text-tertiary); margin-top: 2px; font-style: italic;">
                                    Adds or subtracts from the Universal Counter Plate's recessed dot diameter. The dot size mirrors the Embossing Plate's Dot Base Diameter by default.
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>



                <div class="expert-mode-toggle">
                    <button type="button" id="expert-toggle" class="expert-toggle-btn">
                        <span id="expert-toggle-text">Show Expert Mode</span>
                        <span id="expert-toggle-icon">â–¼</span>
                    </button>
                </div>

                <div id="expert-settings" class="expert-settings" style="display: none;">
                    <div class="expert-info" role="note" aria-label="Expert mode information">
                        Any changes made here will affect both plates.
                    </div>
                    <div class="grade-selection">
                        <label class="grade-label" style="font-size: 1.2em; font-weight: 700;">Braille Dimensions</label>
                        <div>
                            <label for="grid_columns">Number of Braille Cells (Characters):</label>
                            <input type="number" id="grid_columns" name="grid_columns" value="13">
                        </div>
                        <div>
                            <label for="grid_rows">Number of Braille Lines:</label>
                            <input type="number" id="grid_rows" name="grid_rows" value="4">
                        </div>
                        <div>
                            <label for="cell_spacing">Braille Cell Spacing:</label>
                            <input type="number" id="cell_spacing" name="cell_spacing" value="6.5" step="0.1">
                        </div>
                        <div>
                            <label for="line_spacing">Braille Line Spacing:</label>
                            <input type="number" id="line_spacing" name="line_spacing" value="12.0" step="0.1">
                        </div>
                        <div>
                            <label for="dot_spacing">Braille Dot Spacing:</label>
                            <input type="number" id="dot_spacing" name="dot_spacing" value="2.5" step="0.1">
                        </div>
                    </div>

                    <div class="grade-selection">
                        <label class="grade-label" style="font-size: 1.2em; font-weight: 700;">Dot Dimensions</label>
                        <div>
                            <label for="emboss_dot_base_diameter">Dot diameter:</label>
                            <input type="number" id="emboss_dot_base_diameter" name="emboss_dot_base_diameter" value="1.0" step="0.1">
                        </div>
                        <div>
                            <label for="emboss_dot_height">Dot height:</label>
                            <input type="number" id="emboss_dot_height" name="emboss_dot_height" value="0.8" step="0.1">
                        </div>
                        <div>
                            <label for="emboss_dot_flat_hat">Flat hat diameter:</label>
                            <input type="number" id="emboss_dot_flat_hat" name="emboss_dot_flat_hat" value="0.4" step="0.1">
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5em; text-align: center;">
                        <button type="button" id="preview-braille-btn">Preview Braille Translation</button>
                    </div>
                </div>

                <div class="button-group">
                    <!-- Test buttons removed as they are no longer needed -->
                </div>
            </form>
            
            <div id="braille-preview" class="braille-preview" style="display: none;" role="region" aria-label="Braille translation preview">
                <h3 class="preview-heading">Braille Translation Preview:</h3>
                <div id="preview-content"></div>
            </div>
            
            <div id="error-message" role="alert" aria-live="assertive" aria-atomic="true">
                <span style="font-weight:bold;" aria-hidden="true">âš </span> 
                <span id="error-text"></span>
            </div>
        </div>
    </div>
    

    
    <!-- Load the real liblouis JavaScript implementation from node_modules -->
    <script src="/node_modules/liblouis-build/build-no-tables-utf16.js"></script>
    <script src="/node_modules/liblouis/easy-api.js"></script>
    
    <script type="module">
        import * as THREE from '/static/three.module.js';
        import { STLLoader } from '/static/STLLoader.js';
        import { OrbitControls } from '/static/OrbitControls.js';

        // Theme switching functionality
        const themes = ['light', 'dark', 'high-contrast'];
        const themeIcons = {
            'light': 'ðŸŒž',
            'dark': 'ðŸŒ™',
            'high-contrast': 'âš¡'
        };
        const themeNames = {
            'light': 'Light',
            'dark': 'Dark',
            'high-contrast': 'High Contrast'
        };
        
        let currentThemeIndex = 0;
        const savedTheme = localStorage.getItem('preferred-theme');
        if (savedTheme && themes.includes(savedTheme)) {
            currentThemeIndex = themes.indexOf(savedTheme);
            applyTheme(savedTheme);
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = themeToggle.querySelector('.theme-icon');
            const themeText = themeToggle.querySelector('.theme-text');
            
            themeIcon.textContent = themeIcons[theme];
            themeText.textContent = themeNames[theme];
            
            // Update aria-label for current state
            themeToggle.setAttribute('aria-label', `Current theme: ${themeNames[theme]}. Click to switch theme`);
            
            // Save preference
            localStorage.setItem('preferred-theme', theme);
            
            // Announce theme change to screen readers
            const announcement = document.createElement('div');
            announcement.className = 'sr-only';
            announcement.setAttribute('role', 'status');
            announcement.setAttribute('aria-live', 'polite');
            announcement.textContent = `Theme changed to ${themeNames[theme]}`;
            document.body.appendChild(announcement);
            setTimeout(() => announcement.remove(), 1000);
        }

        document.getElementById('theme-toggle').addEventListener('click', () => {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            applyTheme(themes[currentThemeIndex]);
        });

        const form = document.getElementById('braille-form');
        const viewer = document.getElementById('viewer');
        const downloadBtn = document.getElementById('download-btn');
        const generateStlBtn = document.getElementById('generate-stl-btn');

        const previewBrailleBtn = document.getElementById('preview-braille-btn');
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        // Add event handler for the Generate STL button in viewer section
        generateStlBtn.addEventListener('click', () => {
            form.dispatchEvent(new Event('submit'));
        });
        const negativePlateOffsetContainer = document.getElementById('negative-plate-offset-container');
        const expertToggleBtn = document.getElementById('expert-toggle');
        const expertSettings = document.getElementById('expert-settings');
        const expertToggleText = document.getElementById('expert-toggle-text');
        const expertToggleIcon = document.getElementById('expert-toggle-icon');
        const braillePreview = document.getElementById('braille-preview');
        const previewContent = document.getElementById('preview-content');
        const infoToggleBtn = document.getElementById('info-toggle');
        const infoContent = document.getElementById('info-content');
        const infoToggleText = document.getElementById('info-toggle-text');
        const infoToggleIcon = document.getElementById('info-toggle-icon');
        let renderer, scene, camera, mesh, controls;
        let lastSTLUrl = null;

        document.querySelectorAll('input[name="plate_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                negativePlateOffsetContainer.style.display = this.value === 'negative' ? 'block' : 'none';
            });
        });

        // Handle grade selection changes to show appropriate info
        document.querySelectorAll('input[name="grade"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const grade1Info = document.getElementById('grade1-info');
                const grade2Info = document.getElementById('grade2-info');
                
                if (this.value === 'g1') {
                    grade1Info.style.display = 'inline';
                    grade2Info.style.display = 'none';
                } else {
                    grade1Info.style.display = 'none';
                    grade2Info.style.display = 'none'; // Grade 2 info is now inline
                }
            });
        });

        expertToggleBtn.addEventListener('click', () => {
            const isVisible = expertSettings.style.display !== 'none';
            expertSettings.style.display = isVisible ? 'none' : 'block';
            expertToggleText.textContent = isVisible ? 'Show Expert Mode' : 'Hide Expert Mode';
            expertToggleIcon.textContent = isVisible ? 'â–¼' : 'â–²';
            expertToggleBtn.classList.toggle('active', !isVisible);
        });

        infoToggleBtn.addEventListener('click', () => {
            const isVisible = infoContent.style.display !== 'none';
            infoContent.style.display = isVisible ? 'none' : 'block';
            infoToggleText.textContent = isVisible ? 'More Information and Instructions' : 'Hide Information';
            infoToggleIcon.textContent = isVisible ? 'â–¼' : 'â–²';
            infoToggleBtn.classList.toggle('active', !isVisible);
        });

        // Add real-time debugging for Expert Mode parametric dials
        const expertInputs = [
            'emboss_dot_base_diameter',
            'emboss_dot_height', 
            'emboss_dot_flat_hat',
            'grid_columns',
            'grid_rows',
            'cell_spacing',
            'line_spacing',
            'dot_spacing'
        ];
        
        expertInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('input', (e) => {
                    console.log(`Expert Mode Input Changed: ${inputId} = ${e.target.value}`);
                });
                
                // Also log the initial values
                console.log(`Initial value for ${inputId}: ${input.value}`);
            }
        });
        
        // Function to get current Expert Mode values
        window.getCurrentExpertModeValues = function() {
            const values = {};
            expertInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    values[inputId] = input.value;
                }
            });
            return values;
        };

        // Preview braille translation using real liblouis
        previewBrailleBtn.addEventListener('click', async () => {
            const lines = [
                document.getElementById('line1').value,
                document.getElementById('line2').value,
                document.getElementById('line3').value,
                document.getElementById('line4').value
            ];
            
            const grade = document.querySelector('input[name="grade"]:checked').value;
            
            if (lines.every(line => !line.trim())) {
                errorText.textContent = 'Please enter text in at least one line.';
                errorDiv.style.display = 'flex';
                return;
            }

            errorDiv.style.display = 'none';
            let previewHTML = '';
            
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].trim()) {
                    try {
                        // Use real liblouis translation
                        const braille = await translateWithLiblouis(lines[i].trim(), grade);
                        previewHTML += `<div class="preview-line-success">
                            <strong>Line ${i + 1}:</strong> "${lines[i].trim()}" â†’ "${braille}"
                        </div>`;
                    } catch (error) {
                        console.error('Translation failed for line', i + 1, ':', error);
                        previewHTML += `<div class="preview-line-error">
                            <strong>Line ${i + 1}:</strong> "${lines[i].trim()}" â†’ Error: ${error.message}
                        </div>`;
                    }
                }
            }
            
            previewContent.innerHTML = previewHTML;
            braillePreview.style.display = 'block';
        });

        function init3D() {
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(viewer.clientWidth, viewer.clientHeight);
            viewer.innerHTML = '';
            viewer.appendChild(renderer.domElement);
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, viewer.clientWidth/viewer.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 120);
            camera.lookAt(0, 0, 0);
            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 0, 0);
            controls.update();
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(0, 0, 100).normalize();
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x888888));
        }

        function render() {
            renderer.render(scene, camera);
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            errorDiv.style.display = 'none';
            errorText.textContent = '';
            
            // Collect all line inputs
            const lines = [
                document.getElementById('line1').value,
                document.getElementById('line2').value,
                document.getElementById('line3').value,
                document.getElementById('line4').value
            ];
            
            const plateType = document.querySelector('input[name="plate_type"]:checked').value;
            const grade = document.querySelector('input[name="grade"]:checked').value;
            
            // Translate text to braille only for positive plates
            let translatedLines = [];
            if (plateType === 'positive') {
                // Translate text to braille before sending to backend
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        try {
                            console.log(`Translating line ${i + 1}: '${line}' to braille...`);
                            const brailleText = await translateWithLiblouis(line, grade);
                            console.log(`Line ${i + 1} translated: '${line}' â†’ '${brailleText}'`);
                            translatedLines.push(brailleText);
                        } catch (error) {
                            console.error(`Failed to translate line ${i + 1}:`, error);
                            // Fallback to original text if translation fails
                            translatedLines.push(line);
                        }
                    } else {
                        translatedLines.push('');
                    }
                }
                console.log('Original lines:', lines);
                console.log('Translated lines:', translatedLines);
            } else {
                // Counter plates don't need text - just pass empty lines
                translatedLines = ['', '', '', ''];
                console.log('Counter plate selected - no text translation needed');
            }
            const settings = {
                grid_columns: document.getElementById('grid_columns').value,
                grid_rows: document.getElementById('grid_rows').value,
                cell_spacing: document.getElementById('cell_spacing').value,
                line_spacing: document.getElementById('line_spacing').value,
                dot_spacing: document.getElementById('dot_spacing').value,
                emboss_dot_base_diameter: document.getElementById('emboss_dot_base_diameter').value,
                emboss_dot_height: document.getElementById('emboss_dot_height').value,
                emboss_dot_flat_hat: document.getElementById('emboss_dot_flat_hat').value,
                counter_plate_dot_size_offset: document.getElementById('counter_plate_dot_size_offset').value
            };
            
            // Debug: Log the settings being sent
            console.log('Expert Mode Settings:', settings);
            console.log('Settings object keys:', Object.keys(settings));
            console.log('Settings object values:', Object.values(settings));
            
            // Check if at least one line has content (only for positive plates)
            if (plateType === 'positive' && lines.every(line => !line.trim())) {
                errorText.textContent = 'Please enter text in at least one line.';
                errorDiv.style.display = 'flex';
                return;
            }
            
            // Validate braille character limits AFTER translation (only for positive plates)
            if (plateType === 'positive') {
                const gridColumns = parseInt(document.getElementById('grid_columns').value);
                for (let i = 0; i < translatedLines.length; i++) {
                    const brailleLine = translatedLines[i];
                    if (brailleLine && brailleLine.length > gridColumns) {
                        const over = brailleLine.length - gridColumns;
                        errorText.textContent = `Line ${i + 1} exceeds ${gridColumns} braille cells by ${over} cells after translation. Please shorten your text.`;
                        errorDiv.style.display = 'flex';
                        errorDiv.className = 'error-message';
                        return;
                    }
                }
            }
            
            // Show loading message
            errorText.textContent = plateType === 'positive' ? 'Translating text to braille...' : 'Generating counter plate...';
            errorDiv.style.display = 'flex';
            errorDiv.className = 'error-message info';
            
            // Reset download button state
            downloadBtn.classList.remove('ready');
            downloadBtn.setAttribute('aria-disabled', 'true');
            
            // Debug: Log the settings being sent
            console.log('Expert Mode Settings:', settings);
            
            const res = await fetch('/generate_braille_stl', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lines: translatedLines, grade: grade, plate_type: plateType, settings: settings })
            });
            
            // Hide loading message
            errorDiv.style.display = 'none';
            
            if (!res.ok) {
                let msg = 'Error generating STL';
                try {
                    const data = await res.json();
                    if (data.error) msg = data.error;
                } catch (e) {
                    msg = `Server error: ${res.status} ${res.statusText}`;
                }
                errorText.textContent = msg;
                errorDiv.style.display = 'flex';
                errorDiv.className = 'error-message'; // Reset to error style
                // Reset download button state on error
                downloadBtn.classList.remove('ready');
                downloadBtn.setAttribute('aria-disabled', 'true');
                return;
            }
            
            try {
                const blob = await res.blob();
                if (lastSTLUrl) URL.revokeObjectURL(lastSTLUrl);
                lastSTLUrl = URL.createObjectURL(blob);
                loadSTL(lastSTLUrl);
                downloadBtn.classList.add('ready');
                downloadBtn.setAttribute('aria-disabled', 'false');
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = lastSTLUrl;
                    a.download = 'braille_card.stl';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
            } catch (e) {
                errorText.textContent = 'Failed to process STL file: ' + e.message;
                errorDiv.style.display = 'flex';
                errorDiv.className = 'error-message'; // Reset to error style
                // Reset download button state on error
                downloadBtn.classList.remove('ready');
                downloadBtn.setAttribute('aria-disabled', 'true');
            }
        };



        function loadSTL(url) {
            init3D();
            const loader = new STLLoader();
            loader.load(url, function (geometry) {
                geometry.center();
                if (mesh) scene.remove(mesh);
                // Get theme-appropriate mesh color
                const meshColorVar = getComputedStyle(document.documentElement).getPropertyValue('--stl-mesh-color').trim();
                const meshColor = meshColorVar || '#6699cc';
                const material = new THREE.MeshPhongMaterial({ 
                    color: meshColor, 
                    specular: 0x111111, 
                    shininess: 200 
                });
                mesh = new THREE.Mesh(geometry, material);
                mesh.rotation.x = 0;
                scene.add(mesh);
                animate();
            }, undefined, function (error) {
                errorText.textContent = 'Failed to load STL: ' + error;
                errorDiv.style.display = 'flex';
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls && controls.update();
            render();
        }
        
        // Initialize liblouis web worker and 3D viewer on page load
        let liblouisWorker = null;
        let liblouisReady = false;
        let workerMessageId = 0;
        let pendingWorkerMessages = new Map();
        
        // Function to send message to worker and get response
        function sendWorkerMessage(type, data = {}) {
            return new Promise((resolve, reject) => {
                if (!liblouisWorker) {
                    reject(new Error('Worker not initialized'));
                    return;
                }
                
                const id = ++workerMessageId;
                pendingWorkerMessages.set(id, { resolve, reject });
                
                liblouisWorker.postMessage({ id, type, data });
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    if (pendingWorkerMessages.has(id)) {
                        pendingWorkerMessages.delete(id);
                        reject(new Error('Worker message timeout'));
                    }
                }, 10000);
            });
        }
        
        window.addEventListener('load', async () => {
            try {
                // Initialize liblouis web worker
                console.log('Initializing liblouis web worker...');
                
                // Test if worker file is accessible first
                try {
                    const workerResponse = await fetch('/static/liblouis-worker.js');
                    if (!workerResponse.ok) {
                        throw new Error(`Worker file not accessible: ${workerResponse.status}`);
                    }
                    console.log('Worker file is accessible');
                } catch (fetchError) {
                    console.error('Worker file test failed:', fetchError);
                    throw new Error('Cannot access worker file: ' + fetchError.message);
                }
                
                liblouisWorker = new Worker('/static/liblouis-worker.js');
                
                // Handle worker messages
                liblouisWorker.onmessage = function(e) {
                    const { id, type, result } = e.data;
                    
                    if (pendingWorkerMessages.has(id)) {
                        const { resolve, reject } = pendingWorkerMessages.get(id);
                        pendingWorkerMessages.delete(id);
                        
                        if (result.success) {
                            resolve(result);
                        } else {
                            reject(new Error(result.error));
                        }
                    }
                };
                
                liblouisWorker.onerror = function(error) {
                    console.error('Worker error:', error);
                };
                
                // Initialize liblouis in the worker
                const initResult = await sendWorkerMessage('init');
                if (initResult.success) {
                    liblouisReady = true;
                    console.log('Liblouis web worker initialized successfully');
                } else {
                    throw new Error('Failed to initialize liblouis worker: ' + initResult.error);
                }
                
            } catch (error) {
                console.error('Failed to initialize liblouis worker:', error);
                
                // Fallback: disable liblouis and show error message
                console.log('Web worker failed - disabling liblouis translation');
                liblouisReady = false;
                liblouisWorker = null;
                
                // Show user that translation is disabled
                const errorDiv = document.getElementById('error-message');
                const errorText = document.getElementById('error-text');
                if (errorDiv && errorText) {
                    errorText.textContent = 'Web worker failed to initialize. Braille translation preview is disabled on this deployment.';
                    errorDiv.style.display = 'flex';
                }
            }
            
            init3D();
            animate();
        });

        // Function to translate text using liblouis web worker
        async function translateWithLiblouis(text, grade) {
            if (!liblouisReady || !liblouisWorker) {
                throw new Error('Liblouis worker not initialized - translation preview unavailable on this deployment');
            }
            
            try {
                console.log('Sending translation request to worker:', text, 'grade:', grade);
                const result = await sendWorkerMessage('translate', { text, grade });
                
                if (result.success && result.translation) {
                    console.log('Translation successful:', result.translation);
                    return result.translation;
                } else {
                    throw new Error('Translation failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Worker translation failed:', error);
                throw error;
            }
        }




    </script>
</body>
</html> 